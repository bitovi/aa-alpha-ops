name: Integration Tests

on:
  workflow_call:
    inputs:
      frontend_branch:
        type: string
        required: true
      backend_branch:
        type: string
        required: true
    secrets:
      GH_PAT:
        required: true

permissions:
  contents: read

jobs:
  run-integration-tests:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Resolve calling repo
        run: |
          echo "Calling repository: ${{ github.repository }}"
          echo "Frontend branch: ${{ inputs.frontend_branch }}"
          echo "Backend branch: ${{ inputs.backend_branch }}"

      # Checkout the current repo to get docker-compose.yml
      - name: Checkout OPs repo
        uses: actions/checkout@v4
        with:
          repository: bitovi/aa-alpha-ops
          ref: main
          path: ops
          token: ${{ secrets.GH_PAT }}

      # Checkout the frontend repo (aa-alpha-web)
      - name: Checkout frontend
        uses: actions/checkout@v4
        with:
          repository: bitovi/aa-alpha-web
          ref: ${{ inputs.frontend_branch }}
          path: frontend
          token: ${{ secrets.GH_PAT }}

      # Checkout the backend repo (aa-alpha-engine)
      - name: Checkout backend
        uses: actions/checkout@v4
        with:
          repository: bitovi/aa-alpha-engine
          ref: ${{ inputs.backend_branch }}
          path: backend
          token: ${{ secrets.GH_PAT }}

      - uses: actions/setup-node@v4
        with:
          node-version-file: "./frontend/.nvmrc"
      - name: Build Frontend .env
        run: |
          cd ./frontend

          npm ci

          echo "NEXT_PUBLIC_AA_ALPHA_ENGINE_URL=http://localhost:4000" > .env
          echo "NEXT_PUBLIC_AWS_RUM_IDENTITY_POOL=${{ vars.AWS_RUM_IDENTITY_POOL }}" >> .env
          echo "NEXT_PUBLIC_AWS_RUM_ENDPOINT=${{ vars.AWS_RUM_ENDPOINT }}" >> .env
          echo "NEXT_PUBLIC_AWS_APPLICATION_ID=${{ vars.AWS_APPLICATION_ID }}" >> .env
          echo "NEXT_PUBLIC_AWS_APPLICATION_REGION=${{ vars.AWS_APPLICATION_REGION }}" >> .env
          echo "NEXT_PUBLIC_AA_ALPHA_SHA=${{ github.sha }}" >> .env
          echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ vars.CLERK_PUBLISHABLE_KEY }}" >> .env
          echo "CLERK_SECRET_KEY=${{ secrets.CLERK_SECRET_KEY }}" >> .env
          echo "PLAYWRIGHT_DISABLE_WEB_SERVER=true" >> .env
          echo ".env file created"
          cat .env
          cd ..

      - name: Build Backend .env
        run: |
          cd ./backend

          npm ci

          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/alpha_engine" > .env
          echo "API_URL=http://localhost:4000" >> .env
          echo "CANNEX_SOAP_ENDPOINT_URL=https://wwwdev.cannex.com/devext/CANX" >> .env
          echo "CANNEX_SOAP_USERNAME=${{ secrets.CANNEX_SOAP_USERNAME }}" >> .env
          echo "CANNEX_SOAP_PASSWORD=${{ secrets.CANNEX_SOAP_PASSWORD }}" >> .env
          echo "CANNEX_FTP_HOST=${{ vars.CANNEX_FTP_HOST }}" >> .env
          echo "CANNEX_FTP_USER=${{ secrets.CANNEX_FTP_USER }}" >> .env
          echo "CANNEX_FTP_PASSWORD=${{ secrets.CANNEX_FTP_PASSWORD }}" >> .env
          echo "CANNEX_PROD_SOAP_ENDPOINT_URL=${{ vars.CANNEX_PROD_SOAP_ENDPOINT_URL }}" >> .env
          echo "CANNEX_PROD_SOAP_USERNAME=${{ secrets.CANNEX_PROD_SOAP_USERNAME }}" >> .env
          echo "CANNEX_PROD_SOAP_PASSWORD=${{ secrets.CANNEX_PROD_SOAP_PASSWORD }}" >> .env
          echo "INDEX_STANDARD_API_BASE_URL=${{ vars.INDEX_STANDARD_API_BASE_URL }}" >> .env
          echo "INDEX_STANDARD_API_KEY=${{ secrets.INDEX_STANDARD_API_KEY }}" >> .env
          echo "TEMPORAL_CLOUD_API_KEY=${{ secrets.TEMPORAL_CLOUD_API_KEY }}" >> .env
          echo "NAMESPACE=${{ vars.NAMESPACE }}" >> .env
          echo ".env file created"
          cat .env
          cd ..
      - name: Run docker compose
        run: |
          cd ops
          docker compose up -d
          cd ..
        env:
          TEMPORAL_VERSION: 1.27.0
          TEMPORAL_ADMINTOOLS_VERSION: 1.27.0
          TEMPORAL_UI_VERSION: 2.34.0
          NAMESPACE: ${{ vars.NAMESPACE }}

      - name: Import FIA cannex data
        run: |
          cd backend
          npm run temporal:run:cannex-fia
          cd ..
          
      - name: Wait for cannex fia migrations to finish
        uses: GuillaumeFalourd/wait-sleep-action@v1
        with:
          time: '60'

      - name: Run cannex myga migrations
        run: |
          cd backend
          npm run temporal:run:cannex-myga
          cd ..
      - name: Wait for cannex myga migrations to finish
        uses: GuillaumeFalourd/wait-sleep-action@v1
        with:
          time: '30'
      - name: Run integration tests
        run: |
          cd frontend
          npx playwright install --with-deps
          npm run e2e:integration

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30
